#!/bin/bash
# vector sigma 2018

export LC_ALL=C

bold=$(tput bold)
normal=$(tput sgr0)

SRCROOT="$(dirname $0)"
cd "${SRCROOT}"
PREFERRED_SDK="macosx10.11" # Default sdk to build kexts. If exist
PREFERRED_CONF='Release 10.6' # Default configuration to build kexts.
PREFERRED_CONF_APPS='Release' # Default configuration to build kexts.

VERSION=$(svn info | grep '^Revision:' | tr -cd [:digit:])

checkDefaultSDK() {
if [[ -z "$(xcodebuild -showsdks | grep $PREFERRED_SDK)" ]]; then
  PREFERRED_SDK=macosx
  echo "   ..using the latest available sdk"
else
  echo "   ..using the sdk: $PREFERRED_SDK"
fi
}

echo "${bold}** Building HWSensor's extensions r${VERSION} **${normal}"

checkDefaultSDK

rm -rf compilations/Extensions
rm -rf compilations/HWMonitorSMC
rm -rf compilations/HWMonitorSMC2

mkdir -p compilations/Extensions
mkdir -p compilations/HWMonitorSMC
mkdir -p compilations/HWMonitorSMC2
mkdir -p compilations/Extensions_SYMROOT
mkdir -p compilations/HWMonitorSMC_SYMROOT
mkdir -p compilations/HWMonitorSMC2_SYMROOT

cd trunk

# building kernel extensions
xcodebuild -quiet -project HWSensors.xcodeproj \
                -IDEBuildOperationMaxNumberOfConcurrentCompileTasks=`sysctl -n hw.ncpu` \
                -sdk $PREFERRED_SDK \
                -configuration "${PREFERRED_CONF}" \
                SYMROOT="${SRCROOT}/compilations/Extensions_SYMROOT" || exit 1

cp -R "${SRCROOT}/compilations/Extensions_SYMROOT/${PREFERRED_CONF}"/*.kext \
                                          "${SRCROOT}/compilations/Extensions/"

# building HWMonitorSMC.app v1.x
echo "${bold}** Building HWMonitorSMC.app v1 **${normal}"
cd  "${SRCROOT}/trunk/hwmonitor"
xcodebuild -quiet -project HWMonitorSMC.xcodeproj \
                -IDEBuildOperationMaxNumberOfConcurrentCompileTasks=`sysctl -n hw.ncpu` \
                -sdk macosx \
                -configuration "${PREFERRED_CONF_APPS}" \
                SYMROOT="${SRCROOT}/compilations/HWMonitorSMC_SYMROOT" || exit 1

cp -R "${SRCROOT}/compilations/HWMonitorSMC_SYMROOT/${PREFERRED_CONF_APPS}"/HWMonitorSMC.app \
                                              "${SRCROOT}/compilations/HWMonitorSMC/"

# HWMonitorSMC.app v2 can be compiled only with Xcode 9 + and swift 4+
buildv2=0
xver=$(/usr/bin/xcodebuild -version | grep 'Xcode' | awk '{print $NF}')
case "$xver" in
    9*)  buildv2=1;;
    10*) buildv2=1;;
    *)   buildv2=0;;
esac

if [ "$buildv2" -eq "1" ]; then
  echo "${bold}** Building HWMonitorSMC.app v2 **${normal}"
  cd  "${SRCROOT}/trunk/hwmonitor2"
  xcodebuild -quiet -project HWMonitorSMC.xcodeproj \
                    -IDEBuildOperationMaxNumberOfConcurrentCompileTasks=`sysctl -n hw.ncpu` \
                    -sdk macosx \
                    -configuration "${PREFERRED_CONF_APPS}" \
                    SYMROOT="${SRCROOT}/compilations/HWMonitorSMC2_SYMROOT" || exit 1
  cp -R "${SRCROOT}/compilations/HWMonitorSMC2_SYMROOT/${PREFERRED_CONF_APPS}"/HWMonitorSMC2.app \
                                                          "${SRCROOT}/compilations/HWMonitorSMC2/"
else
  echo "HWMonitorSMC.app v2.x requires Xcode 9 +"
fi
