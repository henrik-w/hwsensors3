#!/bin/bash
# vector sigma 2018

export LC_ALL=C

bold=$(tput bold)
normal=$(tput sgr0)

SRCROOT="$(dirname $0)"
cd "${SRCROOT}"
PREFERRED_SDK="macosx10.11" # Default sdk to build kexts. If exist
PREFERRED_CONF='Release 10.6' # Default configuration to build kexts.

VERSION=$(svn info | grep '^Revision:' | tr -cd [:digit:])

checkDefaultSDK() {
if [[ -z "$(xcodebuild -showsdks | grep $PREFERRED_SDK)" ]]; then
  PREFERRED_SDK=macosx
  echo "   ..using the latest available sdk"
else
  echo "   ..using the sdk: $PREFERRED_SDK"
fi
}

echo "${bold}** Building HWSensor's extensions r${VERSION} **${normal}"

checkDefaultSDK

mkdir -p compilations/Extensions
mkdir -p compilations/HWMonitorSMC
mkdir -p compilations/HWMonitorSMC2
mkdir -p compilations/obj

cd trunk

# building kernel extensions
xcodebuild -quiet -project HWSensors.xcodeproj \
                -IDEBuildOperationMaxNumberOfConcurrentCompileTasks=`sysctl -n hw.ncpu` \
                -sdk $PREFERRED_SDK \
                -configuration "${PREFERRED_CONF}" \
                CONFIGURATION_BUILD_DIR="${SRCROOT}/compilations/Extensions" \
                SYMROOT="${SRCROOT}/compilations/obj"  || exit 1

# HWMonitorSMC.app v2 can be compiled only with Xcode 9 + and swift
buildNewHWMonitorSMC() {
local xver=$(/usr/bin/xcodebuild -version | grep 'Xcode' | awk '{print $NF}')
case "$xver" in
    9*) ;;
    10*) ;;
    *) echo "HWMonitorSMC.app v2.x requires Xcode 9 +" && return;;
esac

echo "${bold}** Building HWMonitorSMC.app v2 **${normal}"
cd  "${SRCROOT}/trunk/hwmonitor2"
xcodebuild -quiet -project HWMonitorSMC.xcodeproj \
                -IDEBuildOperationMaxNumberOfConcurrentCompileTasks=`sysctl -n hw.ncpu` \
                -sdk macosx \
                -configuration Release \
                CONFIGURATION_BUILD_DIR="${SRCROOT}/compilations/HWMonitorSMC2" \
                SYMROOT="${SRCROOT}/compilations/HWMonitorSMC2/obj" || exit 1
}


# building HWMonitorSMC.app v1.x
echo "${bold}** Building HWMonitorSMC.app v1 **${normal}"
cd  "${SRCROOT}/trunk/hwmonitor"
xcodebuild -quiet -project HWMonitorSMC.xcodeproj \
                -IDEBuildOperationMaxNumberOfConcurrentCompileTasks=`sysctl -n hw.ncpu` \
                -sdk macosx \
                -configuration Release \
                CONFIGURATION_BUILD_DIR="${SRCROOT}/compilations/HWMonitorSMC" \
                SYMROOT="${SRCROOT}/compilations/HWMonitorSMC/obj" || exit 1

buildNewHWMonitorSMC
